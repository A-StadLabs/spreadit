<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<dom-module id="my-list">
    <style>
      :host {
        display: block;
      }
    </style>
  <template>
  <p>{{locationpos}}</p>

  <firebase-collection
      location="https://spreadit.firebaseio.com/votes"
      id="fbvote"
      data="{{votes}}"
      ></firebase-collection>
 
    <h1>messages</h1>
      <template id="messtemp" is="dom-repeat" items="{{messages}}" as="message">
      <h4>{{message.mess.mess}}</h4>
      <button on-tap="vote" id="{{message.mess.key}}">+1</button>
      <hr>
    </template>

  </template>

</dom-module>
  <script>
    (function () {

 

      var afstand;
      var messages = [];
      var latitude;
      var longitude;

      var build = new Event('build');

// Listen for the event.

// Dispatch the event.
    



    function showPosition(position) {
    //    var that = this;
    latitude = position.coords.latitude;
    longitude = position.coords.longitude;
    window.dispatchEvent(build);
};


      Polymer({
        is: 'my-list',
        properties: {
          items: {
            type: Array,
            notify: true
          },
          latitude: {
            observer: '_latitudeChanged'
          },
          locationpos: {
            type: Boolean,
            value: false
          },
          messages: {
            type: Array,
            value: []
          }    
        },

      


      vote: function(e){
        //console.log(event, detail, sender);
        console.log(e.target.id);
        var newKey = e.target.id;
        // Add ne vote op de nieuwe locatie
        var geoID = this.$.fbvote.add({ 'messageid': newKey, 'value': '1' });

        var geoKey = geoID.key();
        this.doGeofire(geoKey, longitude, latitude);
      },
       

     getLocation: function() {
      var that = this;
      
      
    if (navigator.geolocation) {
        this.locpos = navigator.geolocation.getCurrentPosition(showPosition);
        //console.log(this.locpos);
        
        //this.locationpos = true;
    } else {
        console.log("Geolocation is not supported by this browser.");
    }
},

doGeofire: function(key, long, lat){
  var firebaseRef = new Firebase('https://spreadit.firebaseio.com/geopoints/');
          var geoFire = new GeoFire(firebaseRef);
          geoFire.set(key, [lat, long]).then(function() {
  console.log("Provided key has been added to GeoFire");
}, function(Error) {
  console.log("Error: " + error);
});
},





 deg2rad: function(deg) {
        return deg * (Math.PI/180)
      },

        CalculateDistance: function(lat1,lon1,lat2,lon2) {
          console.log(lat1, lon1, lat2, lon2);
          var R = 6371; // Radius of the earth in km
          var dLat = this.deg2rad(lat2-lat1);  // this.deg2rad below
          var dLon = this.deg2rad(lon2-lon1); 
          var a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) * 
            Math.sin(dLon/2) * Math.sin(dLon/2)
            ; 
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
          var d = R * c; // Distance in km
          return d;
        },

        ready: function() {
          var that = this;
          

          window.addEventListener('build', function () { 
            that.locationpos = true; 
            that.getVotes();
          });

          window.addEventListener('write', function (iets) { 
            console.log('ik schrijf ',iets.detail);
            that.push('messages', {"mess": iets.detail});  
            that.uniQify();
          });

          console.log(latitude, longitude);
          this.locationpos = false;
          console.log('ik ben er list');
          this.getLocation();


          
        },

        uniQify: function(){
          console.log('VOOR uniqufy ',messages);
          messages = _.unique(messages, true);
          console.log('NA uniqufy ',messages);
        },

        getVotes: function(){

          console.log('get votes');

          var that = this;

          var fbgeopoints = new Firebase('https://spreadit.firebaseio.com/geopoints/');

          var fbvotes = new Firebase('https://spreadit.firebaseio.com/votes/');

          var fbmessages = new Firebase('https://spreadit.firebaseio.com/messages/');

          var geoFire = new GeoFire(fbgeopoints);

          //console.log(fbvotes);

          var myLocation = [latitude, longitude];

          console.log(myLocation);

          var geoQuery = geoFire.query({
            center: myLocation,
            radius: 0.025
          });

          var votesInQuery = {};

          geoQuery.on("ready", function() {
            console.log('geofire is ready');
          });

          geoQuery.on("key_entered", function(voteId, voteLocation, voteDistance) {
            console.log('er is iets: ',voteId, voteLocation, voteDistance);
            //voteId = voteId.split(":")[1];
            //votesInQuery[voteId] = true;

             fbvotes.child(voteId).once("value", function(dataSnapshot) {
               // Get the vehicle data from the Open Data Set
              var messageid = dataSnapshot.val().messageid;

                fbmessages.child(messageid).once("value", function(dataSnapshot){

                    var mess = dataSnapshot.val().mess;
                    var key = dataSnapshot.key();

                    messages.push({"key": key, "mess": mess});
                    var event = new CustomEvent('write', { 'detail': {"key": key, "mess": mess} });

                   

                    window.dispatchEvent(event);

                    console.log(messages)
                });

            });
          });

          geoQuery.on("key_exited", function(voteId, voteLocation, voteDistance) {
            console.log('er is iets: ',voteId, voteLocation, voteDistance);
            // voteId = voteId.split(":")[1];
            // votesInQuery[voteId] = true;

            // fbmessages.child(voteId).once("value", function(dataSnapshot) {
            //   // Get the vehicle data from the Open Data Set
            //   vehicle = dataSnapshot.val();
            //   console.log(dataSnapshot.val());

            // });
          });

          geoQuery.on("key_moved", function(voteId, voteLocation, voteDistance) {
            console.log('er is iets: ',voteId, voteLocation, voteDistance);
            // voteId = voteId.split(":")[1];
            // votesInQuery[voteId] = true;

            // fbmessages.child(voteId).once("value", function(dataSnapshot) {
            //   // Get the vehicle data from the Open Data Set
            //   vehicle = dataSnapshot.val();
            //   console.log(dataSnapshot.val());

            // });
          });

        }

      
      });
    })();
  </script>
